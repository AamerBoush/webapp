<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wallet</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#070a12;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --text:#eef2ff;
      --muted:rgba(238,242,255,.62);
      --green:#4cd964;
      --blue:#2b6cff;
      --r:22px;
      --shadow:0 22px 70px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(43,108,255,.18), transparent 60%),
        radial-gradient(700px 520px at 85% 25%, rgba(76,217,100,.10), transparent 60%),
        linear-gradient(180deg,#05070f,var(--bg));
    }
    .wrap{max-width:920px;margin:0 auto;padding:18px 14px 28px}
    .top{
      display:flex;align-items:center;justify-content:space-between;
      padding:8px 2px 14px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .orb{
      width:40px;height:40px;border-radius:16px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.75), transparent 60%),
        linear-gradient(135deg, rgba(43,108,255,.90), rgba(76,217,100,.55));
      border:1px solid var(--stroke);
      box-shadow:0 16px 48px rgba(43,108,255,.18);
    }
    .brand b{display:block;font-weight:950;letter-spacing:.2px}
    .brand small{color:var(--muted)}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
    }
    .gate{
      min-height:72vh;display:grid;place-items:center;
    }
    .gateInner{width:min(560px,100%); padding:18px}
    .eyeBtn{
      width:100%;
      padding:18px 14px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(135deg, rgba(43,108,255,.95), rgba(43,108,255,.55));
      color:#fff;
      font-weight:950;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:10px;
      box-shadow: 0 22px 70px rgba(43,108,255,.18);
    }
    .eyeBtn:disabled{opacity:.45;cursor:not-allowed}
    .hint{
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
      line-height:1.7
    }
    .err{
      margin-top:12px;
      white-space:pre-wrap;word-break:break-word;
      color:rgba(255,255,255,.85);
      font-size:12px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
      display:none;
    }

    .wallet{display:none; gap:14px}
    .pad{padding:18px}

    .balanceWrap{display:grid;place-items:center;text-align:center}
    .balanceLabel{color:var(--muted);font-size:12px}
    .balanceNum{
      font-size:48px;font-weight:1000;letter-spacing:.4px;
      color:var(--green);
      margin:8px 0 6px;
    }
    .rateLine{color:var(--muted);font-size:12px}

    .actions{
      display:grid;grid-template-columns:repeat(3,1fr);
      gap:10px;margin-top:16px;
    }
    .action{
      border-radius:20px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      padding:14px 12px;
      cursor:pointer;
      display:flex;flex-direction:column;align-items:center;gap:10px;
      transition: transform .08s ease;
    }
    .action:active{transform: translateY(1px)}
    .ic{
      width:46px;height:46px;border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      display:grid;place-items:center;
    }
    .action b{font-weight:950;font-size:13px}
    .action small{color:var(--muted);margin-top:-6px}

    .sectionTitle{
      display:flex;align-items:center;justify-content:space-between;
      padding:0 4px;
      margin-top:10px;
      color:rgba(238,242,255,.86);
      font-weight:950;
      font-size:13px;
    }
    .list{
      margin-top:10px;
      display:flex;flex-direction:column;
      gap:10px;
    }
    .item{
      padding:12px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .item .left{display:flex;align-items:center;gap:10px}
    .badge{
      width:36px;height:36px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      display:grid;place-items:center;
    }
    .meta{display:flex;flex-direction:column;gap:2px}
    .meta b{font-size:13px}
    .meta small{color:var(--muted);font-size:12px}
    .amt{
      font-weight:1000;
      font-size:13px;
      white-space:nowrap;
    }
    .amt.out{color:rgba(255,255,255,.86)}
    .amt.in{color:var(--green)}

    /* Sheet */
    .backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:flex-end;justify-content:center;
      padding:14px 14px 22px;
    }
    .sheet{
      width:min(760px, 100%);
      border-radius:26px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(13,18,32,.95);
      box-shadow: 0 40px 120px rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 14px 10px;border-bottom:1px solid rgba(255,255,255,.08);
    }
    .title{font-weight:1000}
    .close{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:rgba(255,255,255,.9);
      border-radius:16px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:950;
      font-size:12px;
    }
    .body{padding:14px}
    .field{
      width:100%;
      padding:12px 12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.92);
      outline:none;font-size:14px;
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
    }
    .grid2{display:grid;gap:10px;grid-template-columns:1fr}
    @media(min-width:720px){ .grid2{grid-template-columns:1fr 1fr} }
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      padding:12px 12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;font-weight:1000;font-size:13px;
    }
    .btn.primary{background: rgba(43,108,255,.20); border-color: rgba(43,108,255,.35)}
    .btn.good{background: rgba(76,217,100,.16); border-color: rgba(76,217,100,.28)}
    .msg{
      margin-top:12px;
      white-space:pre-wrap;word-break:break-word;
      color:rgba(255,255,255,.85);
      font-size:12px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px
    }
    .maxLine{color:var(--muted);font-size:12px;margin-top:8px}
    .maxLink{color:#9bb8ff;cursor:pointer;font-weight:950}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="orb"></div>
        <div>
          <b>Wallet</b>
          <small>TON • Points</small>
        </div>
      </div>
      <!-- لا يوجد Telegram indicator -->
      <button class="close" id="closeApp">إغلاق</button>
    </div>

    <div id="gate" class="gate">
      <div class="card gateInner">
        <button id="open" class="eyeBtn">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12z" stroke="white" stroke-width="2" opacity=".55"/>
            <path d="M4 4l16 16" stroke="white" stroke-width="2" stroke-linecap="round"/>
          </svg>
          فتح المحفظة
        </button>
        <div class="hint">لن يعمل خارج Telegram WebApp. افتحه من زر <b>web_app</b> داخل البوت.</div>
        <div id="gateErr" class="err"></div>
      </div>
    </div>

    <div id="wallet" class="wallet">
      <div class="card pad">
        <div class="balanceWrap">
          <div class="balanceLabel">رصيدك</div>
          <div id="points" class="balanceNum">—</div>
          <div class="rateLine">سعر النقطة: <b id="rate">—</b> TON</div>
        </div>

        <div class="actions">
          <div class="action" id="add">
            <div class="ic">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                <path d="M12 3v10m0 0l-4-4m4 4l4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 17h16" stroke="white" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <b>إضافة نقاط</b>
            <small>TON + Comment</small>
          </div>

          <div class="action" id="send">
            <div class="ic">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                <path d="M3 11l18-8-8 18-2-7-8-3z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <b>إرسال</b>
            <small>Points</small>
          </div>

          <div class="action" id="receive">
            <div class="ic">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                <path d="M12 21V11m0 0l4 4m-4-4l-4 4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 7h16" stroke="white" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <b>استلام</b>
            <small>Code</small>
          </div>
        </div>
      </div>

      <div class="sectionTitle">
        <span>آخر العمليات</span>
        <!-- لا زر تحديث -->
      </div>

      <div id="history" class="list"></div>
    </div>
  </div>

  <div id="backdrop" class="backdrop">
    <div class="sheet">
      <div class="head">
        <div id="sheetTitle" class="title">—</div>
        <button id="closeSheet" class="close">إغلاق</button>
      </div>
      <div id="sheetBody" class="body"></div>
    </div>
  </div>

  <script>
    const API_BASE = "https://insipidly-transdesert-noble.ngrok-free.dev"; // <-- غيّرها

    const gate = document.getElementById("gate");
    const wallet = document.getElementById("wallet");
    const gateErr = document.getElementById("gateErr");

    const pointsEl = document.getElementById("points");
    const rateEl = document.getElementById("rate");
    const historyEl = document.getElementById("history");

    const backdrop = document.getElementById("backdrop");
    const sheetTitle = document.getElementById("sheetTitle");
    const sheetBody = document.getElementById("sheetBody");

    let state = { user_id: 0, points: 0, rate: 0, ton_address: "" };

    function tg(){ return (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null; }
    function joinUrl(base, path){
      if (base.endsWith("/") && path.startsWith("/")) return base.slice(0,-1)+path;
      if (!base.endsWith("/") && !path.startsWith("/")) return base+"/"+path;
      return base+path;
    }
    function showGateErr(msg){
      gateErr.style.display = "block";
      gateErr.textContent = msg;
    }

    async function apiFetch(path, {method="GET", body=null} = {}){
      const t = tg();
      if (!t || !t.initData || t.initData.length === 0) {
        throw new Error("initData غير موجود. افتحها من Telegram عبر زر web_app.");
      }

      const url = joinUrl(API_BASE, path) + (path.includes("?") ? "&" : "?") + "t=" + Date.now();

      const res = await fetch(url, {
        method,
        cache: "no-store",
        headers: {
          "Content-Type":"application/json",
          "X-Telegram-Init-Data": t.initData,
          "ngrok-skip-browser-warning": "1"
        },
        body: body ? JSON.stringify(body) : null
      });

      const ct = (res.headers.get("content-type")||"").toLowerCase();
      if (!ct.includes("application/json")) {
        const text = await res.text().catch(()=> "");
        if (text.includes("ERR_NGROK_6024") || text.includes("ngrok")) {
          throw new Error("ngrok يمنع الوصول (ERR_NGROK_6024).");
        }
        throw new Error("الـ API رجّع HTML بدل JSON. تأكد من API_BASE.");
      }

      const data = await res.json().catch(()=>null);

      if (res.status === 401 || res.status === 403) {
        throw new Error(`${res.status}: ` + ((data && data.detail) ? data.detail : "Blocked"));
      }
      if (!res.ok) {
        throw new Error(`${res.status}: ` + (data && data.detail ? data.detail : JSON.stringify(data)));
      }
      return data;
    }

    async function copy(text){
      try{
        await navigator.clipboard.writeText(text);
        const t = tg();
        if (t && t.HapticFeedback) t.HapticFeedback.impactOccurred("light");
      }catch{}
    }

    function openSheet(title, html){
      sheetTitle.textContent = title;
      sheetBody.innerHTML = html;
      backdrop.style.display = "flex";
    }
    function closeSheet(){
      backdrop.style.display = "none";
      sheetBody.innerHTML = "";
    }
    document.getElementById("closeSheet").onclick = closeSheet;
    backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) closeSheet(); });

    function fmtTime(ts){
      try { return new Date(ts*1000).toLocaleString("ar"); }
      catch { return String(ts); }
    }

    function render(){
      pointsEl.textContent = state.points;
      rateEl.textContent = String(state.rate);
    }

    function renderHistory(items){
      if (!items || items.length === 0){
        historyEl.innerHTML = `<div class="item"><div class="meta"><b>لا يوجد عمليات بعد</b><small>ستظهر هنا التحويلات بعد الإرسال/الاستلام</small></div></div>`;
        return;
      }

      historyEl.innerHTML = items.map(t => {
        const isOut = t.from_uid === state.user_id;
        const title = isOut ? "إرسال نقاط" : "استلام نقاط";
        const sub = isOut ? `إلى UID: ${t.to_uid}` : `من UID: ${t.from_uid}`;
        const amtCls = isOut ? "out" : "in";
        const sign = isOut ? "-" : "+";
        const badge = isOut
          ? `<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 11l18-8-8 18-2-7-8-3z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`
          : `<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 21V11m0 0l4 4m-4-4l-4 4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 7h16" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>`;

        return `
          <div class="item">
            <div class="left">
              <div class="badge">${badge}</div>
              <div class="meta">
                <b>${title}</b>
                <small>${sub} • ${fmtTime(t.ts)}</small>
              </div>
            </div>
            <div class="amt ${amtCls}">${sign}${t.amount}</div>
          </div>
        `;
      }).join("");
    }

    async function loadHistory(){
      const h = await apiFetch("/api/history");
      renderHistory(h.items || []);
    }

    async function openWallet(){
      const boot = await apiFetch("/api/bootstrap");
      state.user_id = Number(boot.user_id || 0);
      state.points = Number(boot.points || 0);
      state.rate = Number(boot.point_price_ton || 0);
      state.ton_address = boot.ton_address || "";
      render();

      // سجلات مرة عند فتح المحفظة (ليس زر تحديث)
      await loadHistory();

      gate.style.display = "none";
      wallet.style.display = "grid";
    }

    // Actions
    document.getElementById("add").onclick = async ()=>{
      try{
        const r = await apiFetch("/api/add/request", {method:"POST"});
        const exp = new Date(r.expires_at * 1000).toLocaleTimeString("ar");
        openSheet("إضافة نقاط (TON)", `
          <div class="grid2">
            <div>
              <div class="hint">عنوان محفظة TON</div>
              <input class="field" readonly value="${r.ton_address}">
              <div class="btnRow"><button class="btn primary" id="c1">نسخ العنوان</button></div>
              <div class="hint" style="margin-top:10px">ضع الكود في خانة Comment/Message عند التحويل.</div>
            </div>
            <div>
              <div class="hint">كود التعليق الخاص بك</div>
              <input class="field" readonly value="${r.deposit_code}">
              <div class="btnRow"><button class="btn primary" id="c2">نسخ الكود</button></div>
              <div class="hint" style="margin-top:10px">ينتهي: <b>${exp}</b></div>
            </div>
          </div>
        `);
        document.getElementById("c1").onclick = ()=> copy(r.ton_address);
        document.getElementById("c2").onclick = ()=> copy(r.deposit_code);
      }catch(e){
        openSheet("خطأ", `<div class="msg">${String(e.message||e)}</div>`);
      }
    };

    document.getElementById("receive").onclick = async ()=>{
      try{
        const r = await apiFetch("/api/receive/request", {method:"POST"});
        const exp = new Date(r.expires_at * 1000).toLocaleTimeString("ar");
        openSheet("استلام نقاط", `
          <div>
            <div class="hint">أرسل هذا الكود للمُرسل (يُستخدم مرة واحدة)</div>
            <input class="field" readonly value="${r.receive_code}">
            <div class="btnRow"><button class="btn good" id="cr">نسخ كود الاستلام</button></div>
            <div class="hint" style="margin-top:10px">ينتهي: <b>${exp}</b></div>
          </div>
        `);
        document.getElementById("cr").onclick = ()=> copy(r.receive_code);
      }catch(e){
        openSheet("خطأ", `<div class="msg">${String(e.message||e)}</div>`);
      }
    };

    document.getElementById("send").onclick = async ()=>{
      openSheet("إرسال نقاط", `
        <div>
          <div class="hint">كود المستلم (RCV-XXXX)</div>
          <input id="to" class="field" placeholder="RCV-XXXXXXXX">
          <div class="hint" style="margin-top:10px">عدد النقاط</div>
          <input id="amt" class="field" type="number" min="1" inputmode="numeric" placeholder="مثال: 25">
          <div class="maxLine">Max <span class="maxLink" id="max">${state.points}</span></div>

          <div class="btnRow">
            <button class="btn primary" id="go">إرسال</button>
            <button class="btn" id="cancel">إلغاء</button>
          </div>

          <div id="out" class="msg">—</div>
        </div>
      `);

      document.getElementById("cancel").onclick = closeSheet;
      document.getElementById("max").onclick = ()=> { document.getElementById("amt").value = String(state.points); };

      document.getElementById("go").onclick = async ()=>{
        const out = document.getElementById("out");
        try{
          const recipient = (document.getElementById("to").value || "").trim().toUpperCase();
          const amount = parseInt(document.getElementById("amt").value || "0", 10);

          if (!recipient.startsWith("RCV-")) throw new Error("كود المستلم غير صحيح");
          if (amount <= 0) throw new Error("الكمية غير صحيحة");
          if (amount > state.points) throw new Error("لا يوجد رصيد كافي");

          out.textContent = "جاري الإرسال…";
          const r = await apiFetch("/api/send", {method:"POST", body:{recipient, amount}});
          out.textContent = "تم ✅";

          // ✅ التحديث التلقائي للرصيد فقط بعد الإرسال
          state.points = Number(r.your_points);
          render();

          // ✅ تحديث السجلات بعد الإرسال
          await loadHistory();

        }catch(e){
          out.textContent = String(e.message||e);
        }
      };
    };

    // Close app
    document.getElementById("closeApp").onclick = ()=>{
      const t = tg();
      if (t) t.close();
      else window.close();
    };

    // Init
    (function init(){
      const t = tg();
      if (!t){
        document.getElementById("open").disabled = true;
        showGateErr("لا يمكن فتحها خارج Telegram WebApp.");
        return;
      }
      t.ready(); t.expand();
      if (!t.initData || t.initData.length === 0){
        document.getElementById("open").disabled = true;
        showGateErr("افتح الصفحة من زر web_app داخل البوت (ليس كرابط).");
      }
    })();

    document.getElementById("open").onclick = async ()=>{
      try{ await openWallet(); }
      catch(e){ showGateErr(String(e.message||e)); }
    };
  </script>
</body>
</html>
