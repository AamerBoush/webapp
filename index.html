<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram WebApp</title>

  <!-- مهم للتوافق: يضمن توفر Telegram.WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #0b0f19; color: #e7eaf3; }
    .wrap { max-width: 820px; margin: 0 auto; padding: 20px; }
    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); margin-bottom: 14px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items:center; justify-content:space-between; }
    .btn { cursor: pointer; border: 0; border-radius: 12px; padding: 10px 14px; background: #2b6cff; color: #fff; font-weight: 600; }
    .btn.secondary { background: rgba(255,255,255,0.10); }
    .btn.danger { background: #ff3b30; }
    .muted { opacity: 0.75; font-size: 13px; }
    pre { white-space: pre-wrap; word-break: break-word; background: rgba(0,0,0,0.35); border-radius: 12px;
      padding: 12px; border: 1px solid rgba(255,255,255,0.10); margin: 10px 0 0; font-size: 13px; line-height: 1.45; }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.10); font-size: 12px; }
    .ok { background: rgba(76, 217, 100, 0.14); border-color: rgba(76, 217, 100, 0.25); }
    .warn { background: rgba(255, 204, 0, 0.12); border-color: rgba(255, 204, 0, 0.25); }
    .bad { background: rgba(255, 59, 48, 0.14); border-color: rgba(255, 59, 48, 0.25); }
    code { background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Telegram WebApp — توثيق بكل Request</h1>
      <div class="row">
        <div>
          <span id="envPill" class="pill warn">جاري التحقق…</span>
          <div class="muted" style="margin-top:6px;">
            API_BASE: <code id="apiBaseText"></code>
          </div>
          <div class="muted" style="margin-top:6px;">
            initData keys: <code id="keysText">—</code>
          </div>
        </div>
        <div class="row" style="justify-content:flex-start;">
          <button class="btn secondary" id="btnReload">تحديث</button>
          <button class="btn danger" id="btnClose">إغلاق</button>
        </div>
      </div>
      <pre id="log">—</pre>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <b>اختبار API</b>
          <div class="muted">/me و /endpoint2</div>
        </div>
        <div class="row" style="justify-content:flex-start;">
          <button class="btn" id="btnMe">/me</button>
          <button class="btn secondary" id="btnPing">/endpoint2</button>
        </div>
      </div>
      <pre id="out">—</pre>
    </div>
  </div>

  <script>
    // غيّر هذا لرابط الـ API (ngrok اللي مربوط على uvicorn)
    const API_BASE = "https://insipidly-transdesert-noble.ngrok-free.dev";

    const elLog = document.getElementById("log");
    const elOut = document.getElementById("out");
    const envPill = document.getElementById("envPill");
    const apiBaseText = document.getElementById("apiBaseText");
    const keysText = document.getElementById("keysText");

    apiBaseText.textContent = API_BASE;

    function setPill(text, cls) {
      envPill.textContent = text;
      envPill.className = `pill ${cls || ""}`;
    }

    function pretty(x) {
      try { return JSON.stringify(x, null, 2); } catch { return String(x); }
    }

    function log(msg) {
      const s = (typeof msg === "string") ? msg : pretty(msg);
      elLog.textContent = (elLog.textContent === "—" ? "" : elLog.textContent + "\n") + s;
    }

    function show(output) {
      elOut.textContent = (typeof output === "string") ? output : pretty(output);
    }

    function joinUrl(base, path) {
      if (!base) return path;
      if (base.endsWith("/") && path.startsWith("/")) return base.slice(0, -1) + path;
      if (!base.endsWith("/") && !path.startsWith("/")) return base + "/" + path;
      return base + path;
    }

    function getTelegram() {
      return window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    }

    function parseKeysOnly(initData) {
      // آمن: نعرض المفاتيح فقط بدون قيم
      try {
        const params = new URLSearchParams(initData);
        const keys = [];
        for (const k of params.keys()) keys.push(k);
        keys.sort();
        return keys.join(", ");
      } catch {
        return "—";
      }
    }

    function getInitDataOrThrow() {
      const tg = getTelegram();
      if (!tg) throw new Error("مش داخل Telegram WebApp (Telegram.WebApp غير موجود).");
      const initData = tg.initData || "";
      if (!initData) throw new Error("initData فاضي. لازم تفتح الصفحة من زر web_app داخل البوت (مو كرابط عادي).");
      return initData;
    }

    async function apiFetch(path, opts) {
      opts = opts || {};
      const initData = getInitDataOrThrow();

      const url = joinUrl(API_BASE, path);
      log(`Request => ${opts.method || "GET"} ${url}`);

      const res = await fetch(url, {
        method: opts.method || "GET",
        headers: Object.assign({
          "Content-Type": "application/json",
          "X-Telegram-Init-Data": initData,
        }, opts.headers || {}),
        body: opts.body ? JSON.stringify(opts.body) : null,
      });

      const ct = (res.headers.get("content-type") || "");
      const data = ct.includes("application/json")
        ? await res.json().catch(() => null)
        : await res.text().catch(() => null);

      if (res.status === 401) {
        const msg = (data && data.detail) ? data.detail : "Unauthorized";
        throw new Error(`401: ${msg}`);
      }
      if (!res.ok) {
        throw new Error(`${res.status}: ${typeof data === "string" ? data : pretty(data)}`);
      }
      return data;
    }

    (function init() {
      const tg = getTelegram();
      document.getElementById("btnReload").onclick = () => location.reload();
      document.getElementById("btnClose").onclick = () => tg ? tg.close() : window.close();

      if (!tg) {
        setPill("خارج Telegram", "bad");
        log("افتح الصفحة من داخل Telegram (WebApp).");
        return;
      }

      tg.ready();
      tg.expand();

      const keys = parseKeysOnly(tg.initData || "");
      keysText.textContent = keys || "—";

      if ((tg.initData || "").length === 0) {
        setPill("داخل Telegram لكن initData فاضي", "warn");
        log("أنت داخل Telegram لكن initData فاضي => غالبًا فتحت الصفحة كرابط عادي، مو كـ web_app button.");
      } else {
        setPill("داخل Telegram ✅", "ok");
        log(`initDataLength = ${(tg.initData || "").length}`);
      }

      // جرّب تلقائيًا /me إذا initData موجود
      if ((tg.initData || "").length > 0) {
        apiFetch("/me").then(show).catch(e => show(String(e.message || e)));
      }
    })();

    document.getElementById("btnMe").onclick = async () => {
      try { show("..."); show(await apiFetch("/me")); }
      catch (e) { show(String(e.message || e)); }
    };

    document.getElementById("btnPing").onclick = async () => {
      try { show("..."); show(await apiFetch("/endpoint2")); }
      catch (e) { show(String(e.message || e)); }
    };
  </script>
</body>
</html>
