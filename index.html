<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>محفظتي</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b0f19;
      --card: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.10);
      --text:#e7eaf3;
      --muted: rgba(231,234,243,0.70);
      --blue:#2b6cff;
      --green:#4cd964;
      --red:#ff3b30;
      --yellow:#ffcc00;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(43,108,255,0.20), transparent 60%),
        radial-gradient(900px 500px at 80% 30%, rgba(76,217,100,0.12), transparent 60%),
        radial-gradient(800px 500px at 40% 90%, rgba(255,204,0,0.10), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{max-width:920px;margin:0 auto;padding:18px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 4px;
    }
    .brand{
      display:flex;align-items:center;gap:10px
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(43,108,255,0.9), rgba(76,217,100,0.5));
      border:1px solid var(--border);
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
    }
    .title{font-weight:800;letter-spacing:0.2px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:2px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      background: rgba(255,255,255,0.08);
      border:1px solid var(--border);
      font-size:12px;color:var(--muted)
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--yellow)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:8px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 18px 55px rgba(0,0,0,0.28);
    }
    .center{
      display:flex;align-items:center;justify-content:center;
      min-height:58vh;
    }
    .primary-btn{
      width:min(520px, 100%);
      padding:18px 16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.16);
      background: linear-gradient(135deg, rgba(43,108,255,0.95), rgba(43,108,255,0.55));
      color:white;
      font-weight:800;
      font-size:16px;
      cursor:pointer;
      box-shadow: 0 26px 70px rgba(43,108,255,0.20);
    }
    .primary-btn:active{transform:translateY(1px)}
    .muted{color:var(--muted)}
    .balance{
      display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap
    }
    .balance .num{
      font-size:38px;font-weight:900;letter-spacing:0.5px
    }
    .balance .label{color:var(--muted);font-size:13px;margin-top:4px}
    .actions{
      display:grid;grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:14px;
    }
    .action-btn{
      padding:14px 10px;border-radius:16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      cursor:pointer;
      display:flex;flex-direction:column;align-items:center;gap:8px;
      transition: transform .08s ease;
    }
    .action-btn:active{transform:translateY(1px)}
    .icon{
      width:42px;height:42px;border-radius:14px;
      display:grid;place-items:center;
      border:1px solid var(--border);
      background: rgba(0,0,0,0.18);
    }
    .icon svg{width:22px;height:22px}
    .action-btn span{font-weight:800}
    .note{
      margin-top:12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding:12px 12px;border-radius:14px;
      border:1px dashed rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.04);
      color:var(--muted);
      font-size:13px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .field{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,0.18);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    .btn{
      padding:11px 12px;border-radius:14px;border:1px solid var(--border);
      background: rgba(255,255,255,0.08);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
    }
    .btn.blue{background: rgba(43,108,255,0.22); border-color: rgba(43,108,255,0.35)}
    .btn.green{background: rgba(76,217,100,0.18); border-color: rgba(76,217,100,0.28)}
    .btn.red{background: rgba(255,59,48,0.14); border-color: rgba(255,59,48,0.25)}
    pre{
      margin:10px 0 0;
      white-space:pre-wrap;word-break:break-word;
      background: rgba(0,0,0,0.30);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      color: rgba(231,234,243,0.85);
      font-size:13px;
      line-height:1.45;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,0.55);
      display:none;align-items:center;justify-content:center;padding:16px;
    }
    .modal{
      width:min(680px, 100%);
      background: rgba(13,18,32,0.92);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:20px;
      padding:16px;
      box-shadow: 0 30px 90px rgba(0,0,0,0.45);
      backdrop-filter: blur(10px);
    }
    .modal-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modal-title{font-weight:900;font-size:16px}
    .close{cursor:pointer;border:1px solid var(--border);background:rgba(255,255,255,0.08);border-radius:14px;padding:9px 10px}
    .two{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    @media (min-width:720px){ .two{grid-template-columns:1fr 1fr} }
    .hint{font-size:13px;color:var(--muted)}
    .sep{height:1px;background:rgba(255,255,255,0.10);margin:12px 0}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">محفظتي</div>
          <div class="subtitle">نقاطك داخل Telegram WebApp</div>
        </div>
      </div>
      <div class="pill"><span class="dot"></span><span id="envText">جاري التحقق…</span></div>
    </div>

    <div id="home" class="card center">
      <button id="openWallet" class="primary-btn">فتح المحفظة</button>
    </div>

    <div id="wallet" class="grid" style="display:none">
      <div class="card">
        <div class="balance">
          <div>
            <div class="num" id="points">—</div>
            <div class="label">رصيد النقاط</div>
          </div>
          <div class="row">
            <button class="btn" id="refreshBtn">تحديث</button>
            <button class="btn red" id="closeBtn">إغلاق</button>
          </div>
        </div>

        <div class="actions">
          <button class="action-btn" id="depositBtn">
            <div class="icon">
              <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0l-4-4m4 4l4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 17h16" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
            </div>
            <span>إيداع</span>
            <small class="muted">TON</small>
          </button>

          <button class="action-btn" id="receiveBtn">
            <div class="icon">
              <svg viewBox="0 0 24 24" fill="none"><path d="M12 21V11m0 0l4 4m-4-4l-4 4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 7h16" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
            </div>
            <span>استلام</span>
            <small class="muted">كود</small>
          </button>

          <button class="action-btn" id="sendBtn">
            <div class="icon">
              <svg viewBox="0 0 24 24" fill="none"><path d="M3 11l18-8-8 18-2-7-8-3z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <span>إرسال</span>
            <small class="muted">نقاط</small>
          </button>
        </div>

        <div class="note">
          <div>سعر النقطة: <b id="rateText">—</b> TON</div>
          <div class="muted">تأكد من فتح الصفحة من زر WebApp داخل البوت</div>
        </div>

        <pre id="status">—</pre>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="backdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">—</div>
        <button class="close" id="modalClose">إغلاق</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    // ✅ ضع رابط السيرفر (API) هنا
    const API_BASE = "https://insipidly-transdesert-noble.ngrok-free.dev";  // <-- عدّلها

    const envText = document.getElementById("envText");
    const home = document.getElementById("home");
    const wallet = document.getElementById("wallet");
    const pointsEl = document.getElementById("points");
    const statusEl = document.getElementById("status");
    const rateText = document.getElementById("rateText");

    const backdrop = document.getElementById("backdrop");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalClose = document.getElementById("modalClose");

    function tg() { return window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null; }

    function joinUrl(base, path) {
      if (base.endsWith("/") && path.startsWith("/")) return base.slice(0, -1) + path;
      if (!base.endsWith("/") && !path.startsWith("/")) return base + "/" + path;
      return base + path;
    }

    function canCallApi() {
      const t = tg();
      return !!t && typeof t.initData === "string" && t.initData.length > 0;
    }

    function setStatus(obj) {
      statusEl.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }

    async function apiFetch(path, {method="GET", body=null} = {}) {
      if (!canCallApi()) {
        throw new Error("لن يتم إرسال طلب للسيرفر: هذه الصفحة ليست WebApp صحيحة أو initData فارغ.");
      }
      const t = tg();
      const url = joinUrl(API_BASE, path);

      const res = await fetch(url, {
        method,
        headers: {
          "Content-Type": "application/json",
          "X-Telegram-Init-Data": t.initData
        },
        body: body ? JSON.stringify(body) : null
      });

      const ct = (res.headers.get("content-type") || "");
      const data = ct.includes("application/json") ? await res.json().catch(()=>null) : await res.text().catch(()=>null);

      if (res.status === 401) throw new Error("401: " + ((data && data.detail) ? data.detail : "Unauthorized"));
      if (!res.ok) throw new Error(res.status + ": " + (typeof data === "string" ? data : JSON.stringify(data)));
      return data;
    }

    async function copyText(text) {
      try {
        await navigator.clipboard.writeText(text);
        const t = tg(); if (t) t.HapticFeedback && t.HapticFeedback.impactOccurred("light");
      } catch {}
    }

    function openModal(title, bodyHtml) {
      modalTitle.textContent = title;
      modalBody.innerHTML = bodyHtml;
      backdrop.style.display = "flex";
    }
    function closeModal() { backdrop.style.display = "none"; }
    modalClose.onclick = closeModal;
    backdrop.addEventListener("click", (e) => { if (e.target === backdrop) closeModal(); });

    async function loadRate() {
      try {
        const r = await apiFetch("/api/rate");
        rateText.textContent = String(r.point_price_ton);
      } catch {
        rateText.textContent = "—";
      }
    }

    async function loadMe() {
      const me = await apiFetch("/api/me");
      pointsEl.textContent = me.points;
      setStatus({ ok: true, user_id: me.user_id, points: me.points });
    }

    document.getElementById("openWallet").onclick = async () => {
      try {
        setStatus("جاري التحميل…");
        await loadRate();
        await loadMe();
        home.style.display = "none";
        wallet.style.display = "block";
      } catch (e) {
        setStatus(String(e.message || e));
      }
    };

    document.getElementById("refreshBtn").onclick = async () => {
      try { setStatus("تحديث…"); await loadRate(); await loadMe(); }
      catch (e) { setStatus(String(e.message || e)); }
    };

    document.getElementById("closeBtn").onclick = () => {
      const t = tg();
      if (t) t.close();
      else window.close();
    };

    document.getElementById("depositBtn").onclick = async () => {
      try {
        const r = await apiFetch("/api/deposit/request", {method:"POST"});
        const exp = new Date(r.expires_at * 1000).toLocaleTimeString("ar");
        openModal("إيداع TON", `
          <div class="two">
            <div>
              <div class="hint">عنوان المحفظة (TON)</div>
              <input class="field" readonly value="${r.ton_address}" />
              <div style="margin-top:8px" class="row">
                <button class="btn blue" id="copyAddr">نسخ العنوان</button>
              </div>
            </div>
            <div>
              <div class="hint">الكود المؤقت (ضعه في التعليق)</div>
              <input class="field" readonly value="${r.deposit_code}" />
              <div style="margin-top:8px" class="row">
                <button class="btn blue" id="copyCode">نسخ الكود</button>
              </div>
            </div>
          </div>
          <div class="sep"></div>
          <div class="hint">ينتهي الكود الساعة: <b>${exp}</b> — ضع الكود في خانة التعليق/الرسالة عند التحويل.</div>
        `);
        document.getElementById("copyAddr").onclick = () => copyText(r.ton_address);
        document.getElementById("copyCode").onclick = () => copyText(r.deposit_code);
      } catch (e) {
        setStatus(String(e.message || e));
      }
    };

    document.getElementById("receiveBtn").onclick = async () => {
      try {
        const r = await apiFetch("/api/receive/code", {method:"POST"});
        const exp = new Date(r.expires_at * 1000).toLocaleTimeString("ar");
        openModal("استلام نقاط", `
          <div>
            <div class="hint">أرسل هذا الكود للشخص الذي سيحوّل لك نقاط</div>
            <input class="field" readonly value="${r.receive_code}" />
            <div style="margin-top:10px" class="row">
              <button class="btn green" id="copyRcv">نسخ كود الاستلام</button>
            </div>
            <div class="sep"></div>
            <div class="hint">ينتهي الكود الساعة: <b>${exp}</b> — يُستخدم مرة واحدة.</div>
          </div>
        `);
        document.getElementById("copyRcv").onclick = () => copyText(r.receive_code);
      } catch (e) {
        setStatus(String(e.message || e));
      }
    };

    document.getElementById("sendBtn").onclick = async () => {
      openModal("إرسال نقاط", `
        <div class="two">
          <div>
            <div class="hint">كم نقطة تريد أن ترسل؟</div>
            <input class="field" id="sendAmount" type="number" inputmode="numeric" min="1" placeholder="مثال: 25" />
          </div>
          <div>
            <div class="hint">كود المستلم (RCV-....)</div>
            <input class="field" id="recipientCode" type="text" placeholder="RCV-XXXXXXXX" />
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button class="btn blue" id="doSend">إرسال الآن</button>
          <button class="btn" id="cancelSend">إلغاء</button>
        </div>
        <pre id="sendOut">—</pre>
      `);

      document.getElementById("cancelSend").onclick = closeModal;

      document.getElementById("doSend").onclick = async () => {
        const out = document.getElementById("sendOut");
        try {
          const amount = parseInt(document.getElementById("sendAmount").value || "0", 10);
          const recipient_code = (document.getElementById("recipientCode").value || "").trim().toUpperCase();
          out.textContent = "جاري الإرسال…";
          const r = await apiFetch("/api/send", {method:"POST", body:{amount, recipient_code}});
          out.textContent = JSON.stringify(r, null, 2);
          await loadMe();
        } catch (e) {
          out.textContent = String(e.message || e);
        }
      };
    };

    (function init(){
      const t = tg();
      if (!t) {
        envText.textContent = "خارج Telegram";
        setStatus("افتح الصفحة من داخل Telegram WebApp (زر web_app في البوت).");
        return;
      }
      t.ready();
      t.expand();
      envText.textContent = (t.initData && t.initData.length > 0) ? "داخل Telegram ✅" : "داخل Telegram لكن initData فارغ";
      loadRate();
    })();
  </script>
</body>
</html>
